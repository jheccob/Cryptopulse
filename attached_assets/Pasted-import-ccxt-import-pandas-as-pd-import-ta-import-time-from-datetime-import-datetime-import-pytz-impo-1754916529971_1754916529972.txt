import os
import ccxt
import pandas as pd
import ta
import time
from datetime import datetime
import pytz
import requests

# ======== CONFIGURAÃ‡Ã•ES ========
# Recomendo guardar TELEGRAM_TOKEN e CHAT_ID nas Secrets do Replit (ENV)
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN", "SEU_TOKEN_AQUI")
CHAT_ID = os.getenv("CHAT_ID", "SEU_CHAT_ID_AQUI")

exchange = ccxt.binance({"enableRateLimit": True})

SYMBOL = 'XLM/USDT'
TIMEFRAME = '5m'
BRAZIL_TZ = pytz.timezone('America/Sao_Paulo')

# Indicadores / limiares
MACD_FAST = 8
MACD_SLOW = 17
MACD_SIGNAL = 9
RSI_PERIOD = 9           # solicitado: RSI mais responsivo
RSI_MIN = 20
RSI_MAX = 80             # limite superior para nÃ£o entrar em sobrecompra
VOLUME_MA = 20

# Tempo do timeframe em segundos (5m)
TIMEFRAME_SECONDS = 5 * 60

# ======== FUNÃ‡Ã•ES ========
def get_ohlcv(limit=200):
    data = exchange.fetch_ohlcv(SYMBOL, timeframe=TIMEFRAME, limit=limit)
    df = pd.DataFrame(data, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
    df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms', utc=True).dt.tz_convert(BRAZIL_TZ)
    return df

def calculate_indicators(df):
    macd = ta.trend.MACD(close=df['close'], window_slow=MACD_SLOW, window_fast=MACD_FAST, window_sign=MACD_SIGNAL)
    df['macd'] = macd.macd()
    df['macd_signal'] = macd.macd_signal()
    df['macd_hist'] = macd.macd_diff()
    rsi = ta.momentum.RSIIndicator(close=df['close'], window=RSI_PERIOD)
    df['rsi'] = rsi.rsi()
    df['vol_ma20'] = df['volume'].rolling(window=VOLUME_MA).mean()
    return df

def send_telegram(message):
    if not TELEGRAM_TOKEN or TELEGRAM_TOKEN == "SEU_TOKEN_AQUI" or not CHAT_ID or CHAT_ID == "SEU_CHAT_ID_AQUI":
        print("Telegram nÃ£o configurado â€” mensagem nÃ£o enviada.")
        return
    url = f'https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage'
    data = {'chat_id': CHAT_ID, 'text': message}
    try:
        requests.post(url, data=data, timeout=10)
    except Exception as e:
        print(f"Erro ao enviar Telegram: {e}")

def check_signal(df):
    """
    Usa candles fechados:
      prev_closed = df.iloc[-3]
      last_closed = df.iloc[-2]
    Regras:
      - MACD cross entre prev_closed e last_closed
      - RSI entre RSI_MIN e RSI_MAX no last_closed
      - RSI em tendÃªncia (subindo/descendo)
      - volume do last_closed > vol_ma20
    """
    if len(df) < 4:
        return None

    prev = df.iloc[-3]   # candle fechado anterior
    last = df.iloc[-2]   # Ãºltimo candle fechado

    needed = ['macd', 'macd_signal', 'rsi', 'vol_ma20']
    if any(pd.isna(prev.get(c)) or pd.isna(last.get(c)) for c in needed):
        return None

    macd_cross_up = (prev['macd'] < prev['macd_signal']) and (last['macd'] > last['macd_signal'])
    macd_cross_down = (prev['macd'] > prev['macd_signal']) and (last['macd'] < last['macd_signal'])

    rsi_ok = (RSI_MIN < last['rsi'] < RSI_MAX)
    rsi_trend_up = last['rsi'] > prev['rsi']
    rsi_trend_down = last['rsi'] < prev['rsi']

    vol_ok = last['volume'] > last['vol_ma20']

    if not (rsi_ok and vol_ok):
        return None

    if macd_cross_up and rsi_trend_up:
        return 'COMPRA'
    if macd_cross_down and rsi_trend_down:
        return 'VENDA'
    return None

# ======== LOOP PRINCIPAL ========
def main():
    print("Bot de alerta iniciado â€” XLM/USDT 5m (usando candles fechados)")
    last_alert_candle_time = None

    while True:
        try:
            df = get_ohlcv(limit=200)
            df = calculate_indicators(df)
            signal = check_signal(df)

            # usar timestamp do candle fechado (Ã­ndice -2)
            last_candle_time = df['timestamp'].iloc[-2]
            prev_candle_time = df['timestamp'].iloc[-3]

            if signal:
                # somente um alerta por candle fechado
                if (last_alert_candle_time is None) or ((last_candle_time - last_alert_candle_time).total_seconds() >= TIMEFRAME_SECONDS):
                    last_rsi = df['rsi'].iloc[-2]
                    # proteÃ§Ã£o extra (seguranÃ§a): evita buy se RSI jÃ¡ estiver > RSI_MAX
                    if signal == 'COMPRA' and last_rsi > RSI_MAX:
                        print(f"[{last_candle_time.strftime('%d/%m %H:%M:%S')}] Skip COMPRA â€” RSI alto ({last_rsi:.1f})")
                    else:
                        price = df['close'].iloc[-2]
                        macd_hist = df['macd_hist'].iloc[-2]
                        time_str = last_candle_time.strftime('%d/%m/%Y %H:%M:%S')
                        msg = (f"ðŸš¨ SINAL {signal}\nPar: {SYMBOL}\nðŸ’° PreÃ§o (close candle): {price:.6f}\n"
                               f"ðŸ“Š RSI({RSI_PERIOD}): {last_rsi:.1f}\nðŸ“ˆ MACD_hist: {macd_hist:.6f}\nðŸ•’ Hora: {time_str} (BSB)")
                        send_telegram(msg)
                        print(f"[{time_str}] {SYMBOL} - Sinal: {signal} - PreÃ§o: {price:.6f} RSI:{last_rsi:.1f} MACD_hist:{macd_hist:.6f}")
                        last_alert_candle_time = last_candle_time
                # else: jÃ¡ enviou alerta para esse candle
            time.sleep(20)  # checa com frequÃªncia razoÃ¡vel (nÃ£o agressiva)
        except Exception as e:
            print(f"Erro no loop principal: {e}")
            time.sleep(30)

if __name__ == "__main__":
    main()